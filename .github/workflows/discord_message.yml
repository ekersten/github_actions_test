name: DEV Deploy
concurrency: dev-environment-deploy

on: push

jobs:
  deploy_and_notify:

    runs-on: ubuntu-latest

    steps:
    
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Create Changelog
      id: changelog
      uses: actions/github-script@v6
      env:
        COMMITS: ${{ toJSON(github.event.commits) }}
      with:
        script: |
            const commits = JSON.parse(process.env.COMMITS);
            return commits.map(commit => ({
              title: `${commit.message} (de: ${commit.author.name})`,
              url: commit.url,
              color: 2664261
            }))
    - name: Discord notification
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DISCORD_EMBEDS: ${{ steps.changelog.outputs.result }}
      uses: Ilshidur/action-discord@master
      with:
        args: 'Nuevos cambios en https://autonauta.egodesign.dev/'

